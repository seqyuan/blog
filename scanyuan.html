<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="ahworld" />
        <meta name="copyright" content="ahworld" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="seurat，scanpy, single-cell, " />

<meta property="og:title" content="生信工程师的自我修养--开发一个python包实现单细胞堆叠小提琴图 "/>
<meta property="og:url" content="/scanyuan.html" />
<meta property="og:description" content="开发一个python包scanyuan实现单细胞堆叠小提琴图" />
<meta property="og:site_name" content="seqyuan" />
<meta property="og:article:author" content="ahworld" />
<meta property="og:article:published_time" content="2020-02-03T00:00:00+08:00" />
<meta name="twitter:title" content="生信工程师的自我修养--开发一个python包实现单细胞堆叠小提琴图 ">
<meta name="twitter:description" content="开发一个python包scanyuan实现单细胞堆叠小提琴图">

        <title>生信工程师的自我修养--开发一个python包实现单细胞堆叠小提琴图  · seqyuan
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/"><span class=site-name>seqyuan</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="">Home</a></li>
                            <li ><a href="/categories.html">Categories</a></li>
                            <li ><a href="/tags.html">Tags</a></li>
                            <li ><a href="/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="/scanyuan.html"> 生信工程师的自我修养--开发一个python包实现单细胞堆叠小提琴图  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p><img alt="a0f277a8cc2341563515ca009945dbb3.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_01.png"></p>
<p>To be or not to be，这么着还是那么着，这是莎士比亚的问题呀！等我们开始做单细胞生信分析，To be or not to be，又变成了大家伙儿的问题了，当下最火的技术嘛！</p>
<p>像我这么个好人，可以这么着也可以那么着，这  “To be or not to be”，什么时候儿？它又变成了我自个儿的问题了呢？</p>
<p>咱们这故事啊，得从<a href="http://www.seqyuan.com/jiangxiaoyu%20story.html">僵小鱼的故事</a>开始说起，她遇见了个顶大的麻烦，在微信群找人帮忙，哎还真有人支招给帮成了，那么这件事和我有什么关系？我是谁呀？我就是讲述<code>僵小鱼的故事</code>，并成为故事一部分的一名普通生信工程师，具体是谁并不重要。</p>
<p>在“僵小鱼的故事”开头我们说道：“许多年之后，面对同一个作图需求，僵小鱼将会回想起，在微信群里提出相同问题的那个遥远的上午”。</p>
<p>时间过的并不慢，回想也没有等到很多年之后才来，就在我写完“僵小鱼的故事”第二天，在同一个微信群又有朋友提出了同一类的问题：单细胞marker基因小提琴图横着堆叠在一起的图有没有现成的代码可以实现？</p>
<p><img alt="3669e9613475e72c0dcd1403810fc487.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_02.png">
<img alt="961f4743e67242f0f17bf6957b2ebebb.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_03.png"></p>
<p>人们给出了和僵小鱼问的问题一样的建议：<code>AI</code>(Adobe Illustrator)；我拿出了前一天刚写好的僵小鱼的故事初版给那位群友看。出人意料的是群里众人的目光投向了我的写作文风以及<a href="www.seqyuan.com">我的博客</a>屈指可数的文章数，那位朋友问题的话题就这样被忽略了。</p>
<p>最终那位朋友做了和僵小鱼一样的选择：<code>AI</code>。</p>
<p><img alt="f6f08d7527114b5ce5e8f2179af84195.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_04.png"></p>
<p><img alt="ba6a20ed80ddab8015d148a8acef3fa7.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_05.png"></p>
<p>虽然我没有帮到他，但是有一点我可以更肯定，僵小鱼看到群里的消息一定会像“僵小鱼的故事”开头写的那样：</p>
<blockquote>
<p>许多年之后，面对同一个作图需求，僵小鱼将会回想起，在微信群里提出相同问题的那个遥远的上午</p>
</blockquote>
<p>而我则想起了在“僵小鱼的故事”中一个未了的心愿，一个吹过的牛皮：</p>
<blockquote>
<p>于是查看了scanpy的源代码，发现是一个叫stacked_violin的函数调用的seaborn.violinplot实现的这个小提琴图，那我就copy一下这个函数，修改一些设置，让它默认出来就是XY转制的小提琴图不就行了。转念又一想还是不浪费时间了。</p>
</blockquote>
<p>回头再来看，故事是好故事，解决了：</p>
<blockquote>
<p>从<a href="https://satijalab.org/seurat/">seurat</a>对象到<a href="https://scanpy-tutorials.readthedocs.io/en/latest/pbmc3k.html">scanpy</a>对象的转换问题，可以应用scanpy丰富的画图函数对seurat的结果画图</p>
</blockquote>
<p>但是scanpy中却没有方法能直接能产出僵小鱼和那位朋友需要的图，而我用图片旋转的解决方法，实现过程不够优雅，最终效果与原图相比也有些差距。
<img alt="90887f626093ac5377d40ab5e56fbd6b.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_06.png"></p>
<p>所以“<code>To be or not to be</code>”它变成了我自个儿的问题，我得把这个事弄圆了。</p>
<p>我先从scanpy源码中找到画堆叠小提琴图的函数stacked_violin，然后拷贝出来重构，命名为stacked_violin_t。
<img alt="518dfce091a33f9b801cfe6dd4c91ad3.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_06.png">
最后<a href="https://mp.weixin.qq.com/s/rc8ky5kqdchJPHVxlQrtRQ">做成一个python包</a>命名为<a href="https://github.com/seqyuan/scanyuan" title="scanyuan">scanyuan</a>，上传到github和PYPI，可以用 <code>pip install scanyuan</code>安装这个包。</p>
<p>下面所谓<code>现成的代码</code>就是：读入数据，并用<code>scanyuan</code>中的<code>stacked_violin_t</code>方法实现文章堆叠小提琴图，</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">scanyuan</span> <span class="k">as</span> <span class="nn">scy</span>

<span class="c1"># 此处示例为读取loom文件，也可以是其他scanpy支持的数据格式</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_loom</span><span class="p">(</span><span class="s2">&quot;/Users/yuanzan/Desktop/tmp/sdata.loom&quot;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">X_name</span><span class="o">=</span><span class="s1">&#39;spliced&#39;</span><span class="p">,</span> <span class="n">obs_names</span><span class="o">=</span><span class="s1">&#39;CellID&#39;</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="s1">&#39;Gene&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">marker_genes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Stfa1&#39;</span><span class="p">,</span> <span class="s1">&#39;Ngp&#39;</span><span class="p">,</span> <span class="s1">&#39;Ccl5&#39;</span><span class="p">,</span> <span class="s1">&#39;Ccl4&#39;</span><span class="p">,</span> <span class="s1">&#39;BC100530&#39;</span><span class="p">,</span> <span class="s1">&#39;Gzma&#39;</span><span class="p">,</span> <span class="s1">&#39;Gata2&#39;</span><span class="p">,</span> <span class="s1">&#39;Cd74&#39;</span><span class="p">]</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">scy</span><span class="o">.</span><span class="n">stacked_violin_t</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">marker_genes</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;ClusterName&#39;</span><span class="p">)</span>
</code></pre></div>

<p>以下两张图是最终成图的效果展示</p>
<p><img alt="795b900741e3bf3c1d8c7c6d80c6f354.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_07.png">
<img alt="4911c6e11d609ba1931c1f82bce4e6f2.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_08.png"></p>
<p><img alt="05c91d1e716db20058dfc6af23b6ea32.jpeg" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_09.png"></p>
<p>这篇文章其实早已写就，故事到这里也本该就结束了，但是在<a href="https://mp.weixin.qq.com/s/REUH4Wzt1fT6HQD2LDgthg">僵小鱼的故事</a>文章发出之后，有一位叫<code>黑川五郎</code>的朋友留言说他开发了一个R包<a href="https://github.com/lyc-1995/MySeuratWrappers">MySeuratWrappers</a>实现了我们这次这介绍的<code>scanyuan</code>同样的功能。</p>
<p><img alt="6f02c8c3651cb46a9955bdacb5f39b9d.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scanyuan/scanyuan_10.png"></p>
<p>殊途同归，能遇到同道是我们的幸运。我想，乐于分享，利用自己的技能带给自己和别人一点点便利，是每一个生信工程师自我修养的一部分。</p>
<p>欢迎扫码关注生信微信公众号</p>
<p><img alt="seqyuan" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/seqyuan.jpg"></p>
            
            
            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4><a href="/author/ahworld.html"> <i class="icon-user"></i>ahworld</a></h4>

            <!--<h4>Published</h4>-->
			<h4><time pubdate="pubdate" datetime="2020-02-03T00:00:00+08:00"><i class="icon-calendar"></i>2020-02-03</time></h4>

            <h4><i class="icon-folder-open"></i>Category</h4>
            <a class="category-link" href="/categories.html#single-cell-ref">single-cell</a>
            <h4><i class="icon-tag"></i>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#seuratscanpy-ref">seurat，scanpy
                    <span>1</span>
</a></li>
            </ul>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Designed by <a href="http://www.seqyuan.com/" title="Seqyuan Home Page">Yuan Zan</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>