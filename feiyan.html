<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="ahworld" />
        <meta name="copyright" content="ahworld" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="map, python, map, " />

<meta property="og:title" content="python实现COVID-19肺炎疫情地图 "/>
<meta property="og:url" content="/feiyan.html" />
<meta property="og:description" content="python实现COVID-19肺炎疫情分布地图" />
<meta property="og:site_name" content="seqyuan" />
<meta property="og:article:author" content="ahworld" />
<meta property="og:article:published_time" content="2020-02-14T00:00:00+08:00" />
<meta name="twitter:title" content="python实现COVID-19肺炎疫情地图 ">
<meta name="twitter:description" content="python实现COVID-19肺炎疫情分布地图">

        <title>python实现COVID-19肺炎疫情地图  · seqyuan
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/"><span class=site-name>seqyuan</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="">Home</a></li>
                            <li ><a href="/categories.html">Categories</a></li>
                            <li ><a href="/tags.html">Tags</a></li>
                            <li ><a href="/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="/feiyan.html"> python实现COVID-19肺炎疫情地图  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>此次新型冠状病毒肺炎疫情影响甚广，很多网站推出了疫情分布地图供我们时时追踪全国各地的疫情情况。</p>
<p><img alt="feiyan_1.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_1.png"></p>
<p>我们自己要用python实现这个图需要解决两个大的问题：</p>
<ul>
<li>[ ] 获取全国各地确诊数据</li>
<li>[ ] 选取合适的python包画地图</li>
</ul>
<blockquote>
<p>我的运行环境是<code>MACOS</code> chrom浏览器 + jupyter notebook，jupyter notebook可通过安装<a href="https://www.anaconda.com/distribution/#download-section">Anaconda</a>获得</p>
</blockquote>
<h2>获取全国各地确诊数据</h2>
<p>我们选择采用网络爬虫技术获取数据，目标是：<a href="https://news.qq.com//zt2020/page/feiyan.htm#charts">腾讯疫情地图网页</a></p>
<p>解析网页分析获取数据的技术我们在<a href="https://mp.weixin.qq.com/s/km5ZUSDFtr7VGjZswdQPVw">python实现NBA球员出手位置图表</a>这篇文章中介绍过，具体步骤如下：</p>
<h5>1）解析网页，分析确诊数据来源</h5>
<ul>
<li>打开chrom浏览器</li>
<li>打开一个空白网页</li>
<li>在网页上点击右键</li>
<li>选择<code>检查</code></li>
</ul>
<p><img alt="feiyan_2.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_2.png"></p>
<ul>
<li>在网页的地址栏输入<a href="https://news.qq.com//zt2020/page/feiyan.htm#charts">腾讯疫情地图网页</a></li>
</ul>
<p>我们依次查看<code>Network</code>涉及到的各种网页链接，最终发现全国各省的确诊数据是以Json格式存储</p>
<p><img alt="feiyan_3.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_3.png"></p>
<p>从<code>Headers</code>我们获取到数据存放的网址
<img alt="feiyan_4.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_4.png"></p>
<h5>2）用代码下载数据</h5>
<p>我们用以下python代码获取数据存储到<code>data</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span><span class="nn">json</span><span class="o">,</span><span class="nn">requests</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://view.inews.qq.com/g2/getOnsInfo?name=disease_h5&amp;callback=&amp;_=</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
</code></pre></div>

<p>data中包含以下数据，其中<code>areaTree</code>包含我们需要的各省确诊数据</p>
<div class="highlight"><pre><span></span><code>lastUpdateTime
chinaTotal
chinaAdd
isShowAdd
chinaDayList
chinaDayAddList
dailyNewAddHistory
dailyDeadRateHistory
confirmAddRank
areaTree
articleList
</code></pre></div>

<h2>选取合适的python包画地图</h2>
<p>我们选取<a href="https://geopandas.org/install.html">geopandas</a>这个python包画地图，我们先画一幅世界地图做测试</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">world</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geopandas</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;naturalearth_lowres&#39;</span><span class="p">))</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">world</span><span class="p">[(</span><span class="n">world</span><span class="o">.</span><span class="n">pop_est</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">name</span><span class="o">!=</span><span class="s2">&quot;Antarctica&quot;</span><span class="p">)]</span>
<span class="n">world</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<p><img alt="feiyan_5.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_5.png"></p>
<p>geopandas结合了pandas和shapely的功能，扩展了pandas在空间数据操作方面的能力，使得可以轻松的用python实现空间数据分析，<code>geometry</code>列为地图坐标信息。</p>
<p><img alt="feiyan_6.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_6.png"></p>
<h5>1）下载中国地图，并整理</h5>
<p>我们从<a href="https://gadm.org/download_country_v3.html">GADM</a>网站下载中国行政区划分地图，以下是我下载的地图，，解压后使用，具体下载链接参考文末的<code>Reference</code></p>
<ul>
<li><a href="https://data.biogeo.ucdavis.edu/data/gadm3.6/shp/gadm36_CHN_shp.zip">gadm36_CHN_shp</a></li>
<li><a href="https://data.biogeo.ucdavis.edu/data/gadm3.6/shp/gadm36_HKG_shp.zip">gadm36_HKG_shp</a></li>
<li><a href="https://data.biogeo.ucdavis.edu/data/gadm3.6/shp/gadm36_MAC_shp.zip">gadm36_MAC_shp</a></li>
<li><a href="https://data.biogeo.ucdavis.edu/data/gadm3.6/shp/gadm36_TWN_shp.zip">gadm36_TWN_shp</a></li>
</ul>
<p>其中<code>gadm36_CHN_shp</code>包含3组数据</p>
<ul>
<li>gadm36_CHN_1.shp：省、自治区、直辖市单位划分</li>
<li>gadm36_CHN_2.shp：市级单位划分</li>
<li>gadm36_CHN_3.shp：县级单位划分</li>
</ul>
<p>从GADM下载的地图，中国大陆和港、澳、台的文件是分开的，所以用以下代码合并地图数据</p>
<div class="highlight"><pre><span></span><code><span class="n">mainland_map</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;/Users/yuanzan/Desktop/tmp/gadm36_CHN_shp/gadm36_CHN_1.shp&#39;</span><span class="p">)</span>
<span class="n">HK_map</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;/Users/yuanzan/Desktop/tmp/map/gadm36_HKG_shp/gadm36_HKG_0.shp&#39;</span><span class="p">)</span>
<span class="n">HK_p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;GID_0&#39;</span><span class="p">:</span><span class="s1">&#39;CHN&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME_0&#39;</span><span class="p">:</span><span class="s1">&#39;China&#39;</span><span class="p">,</span> <span class="s1">&#39;GID_1&#39;</span><span class="p">:</span><span class="s1">&#39;CHN.32_1&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;Hongkong&#39;</span><span class="p">,</span> <span class="s1">&#39;VARNAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;Hongkong&#39;</span><span class="p">,</span> <span class="s1">&#39;NL_NAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;香港&#39;</span><span class="p">,</span> <span class="s1">&#39;TYPE_1&#39;</span><span class="p">:</span><span class="s1">&#39;tebiexingzhengqu&#39;</span><span class="p">,</span> <span class="s1">&#39;ENGTYPE_1&#39;</span><span class="p">:</span><span class="s1">&#39;SAR&#39;</span><span class="p">,</span> <span class="s1">&#39;CC_1&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;HASC_1&#39;</span><span class="p">:</span><span class="s1">&#39;CN.HK&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">HK_p</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HK_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>

<span class="n">MAC_map</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;/Users/yuanzan/Desktop/tmp/map/gadm36_MAC_shp/gadm36_MAC_0.shp&#39;</span><span class="p">)</span>
<span class="n">MAC_p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;GID_0&#39;</span><span class="p">:</span><span class="s1">&#39;CHN&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME_0&#39;</span><span class="p">:</span><span class="s1">&#39;China&#39;</span><span class="p">,</span> <span class="s1">&#39;GID_1&#39;</span><span class="p">:</span><span class="s1">&#39;CHN.33_1&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;Macao&#39;</span><span class="p">,</span> <span class="s1">&#39;VARNAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;Macao&#39;</span><span class="p">,</span> <span class="s1">&#39;NL_NAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;澳门&#39;</span><span class="p">,</span> <span class="s1">&#39;TYPE_1&#39;</span><span class="p">:</span><span class="s1">&#39;tebiexingzhengqu&#39;</span><span class="p">,</span> <span class="s1">&#39;ENGTYPE_1&#39;</span><span class="p">:</span><span class="s1">&#39;SAR&#39;</span><span class="p">,</span> <span class="s1">&#39;CC_1&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;HASC_1&#39;</span><span class="p">:</span><span class="s1">&#39;CN.MAC&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">MAC_p</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAC_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>

<span class="n">TW_map</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;/Users/yuanzan/Desktop/tmp/map/gadm36_TWN_shp/gadm36_TWN_0.shp&#39;</span><span class="p">)</span>
<span class="n">TW_p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;GID_0&#39;</span><span class="p">:</span><span class="s1">&#39;CHN&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME_0&#39;</span><span class="p">:</span><span class="s1">&#39;China&#39;</span><span class="p">,</span> <span class="s1">&#39;GID_1&#39;</span><span class="p">:</span><span class="s1">&#39;CHN.34_1&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;Taiwan&#39;</span><span class="p">,</span> <span class="s1">&#39;VARNAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;Taiwan&#39;</span><span class="p">,</span> <span class="s1">&#39;NL_NAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;台湾&#39;</span><span class="p">,</span> <span class="s1">&#39;TYPE_1&#39;</span><span class="p">:</span><span class="s1">&#39;Shěng&#39;</span><span class="p">,</span> <span class="s1">&#39;ENGTYPE_1&#39;</span><span class="p">:</span><span class="s1">&#39;Province&#39;</span><span class="p">,</span> <span class="s1">&#39;CC_1&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;HASC_1&#39;</span><span class="p">:</span><span class="s1">&#39;CN.TW&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">TW_p</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>

<span class="n">mainland_map</span> <span class="o">=</span> <span class="n">mainland_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HK_p</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">mainland_map</span> <span class="o">=</span> <span class="n">mainland_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MAC_p</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">mainland_map</span> <span class="o">=</span> <span class="n">mainland_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TW_p</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>通过前期的观察，我们发现从腾讯网站下载的<code>data</code>中的省命名与<code>mainland_map</code>地图中存储的命名不一致，所以用以下代码调整一致</p>
<div class="highlight"><pre><span></span><code><span class="n">mainland_map_c</span> <span class="o">=</span> <span class="n">mainland_map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mainland_map</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;NL_NAME_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">jian</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;自治区&#39;</span> <span class="ow">in</span> <span class="n">jian</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jian</span> <span class="o">==</span> <span class="s2">&quot;内蒙古自治区&quot;</span><span class="p">:</span>
                <span class="n">mainland_map_c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;NL_NAME_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;内蒙古&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mainland_map_c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;NL_NAME_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jian</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;黑龙江省&quot;</span><span class="p">:</span>
                <span class="n">mainland_map_c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;NL_NAME_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;黑龙江&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mainland_map_c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;NL_NAME_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jian</span>
</code></pre></div>

<p>简单画图预览<code>mainland_map_c.plot()</code></p>
<p><img alt="feiyan_7.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_7.png"></p>
<h5>2）合并地图与data中的各省确诊病例数据</h5>
<div class="highlight"><pre><span></span><code><span class="n">mainland_map_c</span><span class="p">[</span><span class="s1">&#39;confirm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mainland_map_c</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">mainland_map_c</span><span class="p">[</span><span class="s1">&#39;NL_NAME_1&#39;</span><span class="p">]</span>
<span class="n">mainland_map_c</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;areaTree&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
    <span class="n">mainland_map_c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="s1">&#39;confirm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">][</span><span class="s1">&#39;confirm&#39;</span><span class="p">]</span>
</code></pre></div>

<h5>3）画图</h5>
<p>以下代码第一行为MACOS系统上显示中文设置，Win/Linux系统的设置请参考<a href="https://mp.weixin.qq.com/s/SHuLZRMAAenaWWxrQ5vbRA">python3字体解决大挖掘</a></p>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Arial Unicode MS&#39;</span>

<span class="k">def</span> <span class="nf">set_frame</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">mainland_map_c</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;confirm&quot;</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;User_Defined&quot;</span><span class="p">,</span> <span class="n">classification_kwds</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">10000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;OrRd&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
<span class="n">leg</span><span class="o">.</span><span class="n">_loc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">]</span>
<span class="n">leg</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">leg</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1-9人&#39;</span><span class="p">,</span><span class="s1">&#39;10-99人&#39;</span><span class="p">,</span><span class="s1">&#39;100-499人&#39;</span><span class="p">,</span><span class="s1">&#39;500-999人&#39;</span><span class="p">,</span><span class="s1">&#39;1000-999人&#39;</span><span class="p">,</span><span class="s1">&#39;10000人及以上&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">get_texts</span><span class="p">()):</span>
    <span class="n">v</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">set_frame</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="c1">#mainland_map_c.apply(lambda x: ax.annotate(s=x.NL_NAME_1, xy=x.geometry.centroid.coords[0], ha=&#39;center&#39;),axis=1);</span>
</code></pre></div>

<p>以下两图为加与不加最后一行的结果图</p>
<p><img alt="96aab34249cdf1f3d977789890f63718.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_8.png"></p>
<p><img alt="ecbb471165cd459426e9f7b067e1b2a4.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_9.png"></p>
<h3>单个省城市疫情地图的绘制</h3>
<p>我们以河北省为例，读取的地图数据要选取<code>gadm36_CHN_2.shp</code></p>
<h5>1）读取市级地图数据并整理城市命名</h5>
<div class="highlight"><pre><span></span><code><span class="n">city_map</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;/Users/yuanzan/Desktop/tmp/gadm36_CHN_shp/gadm36_CHN_2.shp&#39;</span><span class="p">)</span>

<span class="n">city_map_hebei</span> <span class="o">=</span> <span class="n">city_map</span><span class="p">[</span><span class="n">city_map</span><span class="p">[</span><span class="s1">&#39;NL_NAME_1&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;河北&#39;</span><span class="p">]</span>
<span class="n">city_map_hebei_c</span> <span class="o">=</span> <span class="n">city_map_hebei</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">city_map_hebei</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">city_map_hebei_c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;NL_NAME_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;NL_NAME_2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;市&#39;</span><span class="p">)</span>

<span class="n">city_map_hebei_c</span><span class="p">[</span><span class="s1">&#39;confirm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">city_map_hebei_c</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">city_map_hebei_c</span><span class="p">[</span><span class="s1">&#39;NL_NAME_2&#39;</span><span class="p">]</span>
</code></pre></div>

<h5>2）合并地图与data中的各市确诊病例数据</h5>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;areaTree&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;河北&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
            <span class="n">city_map_hebei_c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span><span class="s1">&#39;confirm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">][</span><span class="s1">&#39;confirm&#39;</span><span class="p">]</span>
</code></pre></div>

<h5>3）画图</h5>
<div class="highlight"><pre><span></span><code><span class="n">ax</span> <span class="o">=</span> <span class="n">city_map_hebei_c</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;confirm&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;OrRd&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">city_map_hebei_c</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">NL_NAME_2</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">confirm</span><span class="p">),</span> <span class="n">xy</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">set_frame</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>

<p><img alt="c933dcaffa120c21a215e061355f38f7.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/feiyan/feiyan_10.png"></p>
<h3>代码github地址</h3>
<p>代码已做成<a href="https://github.com/seqyuan/feiyanMap">ipynb</a>上传到我的github，可直接在<code>jupyter notebook</code>中运行测试。</p>
<p>地图数据如果在官网下载慢，可以在我的百度网盘下载</p>
<ul>
<li><strong>链接</strong>:https://pan.baidu.com/s/1-Eo3q21eGrz8ABBhK4ySow  </li>
<li><strong>密码</strong>:r8pl</li>
</ul>
<p>欢迎扫码关注生信微信公众号</p>
<p><img alt="seqyuan" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/seqyuan.jpg"></p>
            
            
            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4><a href="/author/ahworld.html"> <i class="icon-user"></i>ahworld</a></h4>

            <!--<h4>Published</h4>-->
			<h4><time pubdate="pubdate" datetime="2020-02-14T00:00:00+08:00"><i class="icon-calendar"></i>2020-02-14</time></h4>

            <h4><i class="icon-folder-open"></i>Category</h4>
            <a class="category-link" href="/categories.html#map-ref">map</a>
            <h4><i class="icon-tag"></i>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#map-ref">map
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#python-ref">python
                    <span>1</span>
</a></li>
            </ul>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Designed by <a href="http://www.seqyuan.com/" title="Seqyuan Home Page">Yuan Zan</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>